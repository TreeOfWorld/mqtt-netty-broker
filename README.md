# mqtt-netty-broker

一个基于netty的轻量的mqtt broker实现。

## 技术栈

spring boot 3.3
netty 4.1.113.Final
jdk：openjdk-21.0.7

## 项目背景

IoT场景下，网络环境可能不稳定，存在弱网、带宽受限等问题，需要通过mqtt协议实现通信

### 弱网环境

清晰地描述问题，是我们能够解决问题的前提。我们的目标既然是解决弱网环境下的通信问题，那么受限要明确何为弱网？

在物联网/MQTT语境下，“弱网”（Weak Network）是一组网络质量劣化的综合状态，通常通过以下可量化指标界定：

1. 核心指标阈值

| 参数        | 正常网络      | 弱网环境        | 测量工具         |
|-----------|-----------|-------------|--------------|
| 往返延迟（RTT） | < 100ms   | ≥ 500ms     | ping/tcpping |
| 丢包率       | < 0.1% ≥  | 5%          | Wireshark统计  |
| 带宽波动      | 波动< 20%   | 瞬时带宽下降> 80% | iperf        |
| 连接中断频率    | < 1次/小时 ≥ | 10次/小时      | 心跳包超时计数      

2. 典型弱网场景

- 物理层问题
    - 2G/3G网络切换基站时的300-2000ms延迟
    - NB-IoT的20dB深度覆盖衰减（如地下车库）

- 协议层问题
    - TCP在丢包时的指数退避（如Linux内核默认重试13次/分钟）
    - MTU不匹配导致的IP分片（如4G默认1500字节 vs LoRa的242字节）

- 业务层表现
    - MQTT的PUBLISH报文超过3次重传（QoS=1）
    - KeepAlive超时后仍能自动恢复连接

### mqtt协议的优势

- 弱网友好：报文内容少，所以自然弱网友好

一、弱网/断网场景下的挑战

在弱网或断网的情况下，MQTT网关主要面临以下几个挑战：

1. 数据丢失风险：在网络不稳定或中断时，数据可能无法及时发送或接收，导致数据丢失。
2. 连接中断：MQTT依赖于TCP连接，网络中断会导致连接丢失，需要有效的重连机制。
3. 数据顺序和完整性：在网络恢复后，如何确保数据按照正确的顺序传输，并保持其完整性。
4. 资源消耗：在弱网环境下，重复尝试发送大量数据可能会导致资源消耗过大。

## 测试场景

### 分布式部署

### 弱网环境测试

弱网对报文大小的影响
延时对报文大小的影响

## 优化方向

针对MQTT远程控制的实时性要求，需从协议参数优化、业务层设计、网络容错三方面综合处理：

### 协议参数优化

### 业务层补偿机制

1. 多通道冗余【两倍的连接数据量，初步判断不合适】

   通道类型 用途 延迟容忍
   MQTT主通道 控制指令（QoS 1）    <1s
   UDP备用通道 心跳检测（端口探测）    <100ms
   注：通过UDP端口活跃性辅助判断设备真实状态

2. 本地缓存+ACK聚合

    ```java
    // 设备端伪代码
    void onMessageReceived(String cmd) {
        if (isWeakNetwork()) {
            storeToFlash(cmd);  // 弱网时先持久化
            sendDelayedACK();   // 延迟聚合ACK（如每3条批量回复）
        } else {
            executeImmediately(cmd);
        }
    }
    ```

3. 指令优先级队列
   ```mermaid
   graph LR
       A[紧急指令:重启] -->|最高优先级| B[立即抢占发布]
       C[普通指令:参数设置] -->|QoS1| D[按序处理]
   ```

### 网络层增强措施

1. 链路质量探测【这个链路的探测需要增加】

    - 动态计算网络健康度

         ```text
         健康度 = (最近10次PUBACK平均延迟) / (当前信号强度)  
         当健康度>阈值时，自动切换为精简指令模式
         ```
2. 自适应压缩【这个方案着重考虑一下】

    - 对JSON指令采用CBOR压缩（可减少50%体积）：[参考文章](https://blog.csdn.net/qq_51700102/article/details/145076346)
      ```json
      // 原始指令
      {"cmd":"set_temp","value":25}
      // CBOR编码后（16进制）
      A2 63 636D64 68 7365745F74656D70 65 76616C7565 18 19
      ```
实测数据参考
在2G网络（丢包率8%）下的优化效果对比：

方案	平均响应时间	成功率
默认MQTT	2.4s	72%
本文综合方案	0.9s	95%
关键结论
弱网无法被完全消除，但可通过协议优化将秒级响应成功率提升至90%+
必须采用业务层ACK聚合+网络层探测的组合方案
对绝对实时性要求的指令（如急停），建议增加UDP广播作为备份通道

> [临时参考](https://fc.fittenlab.cn/?share=6262025_eqrnsx3s1)

可以考虑参考一下海康和大华的方案

https://blog.csdn.net/weixin_39710361/article/details/113628509
https://www.emqx.com/zh/blog/connecting-mqtt-sn-devices-using-emqx

https://blog.csdn.net/weixin_41563161/article/details/105310459

https://www.cnblogs.com/111testing/p/12810253.html
